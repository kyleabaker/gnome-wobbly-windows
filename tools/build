#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

# ---------------------------
# Helper functions for logging
# ---------------------------
info()  { echo -e "\033[1;34m[INFO]\033[0m $*"; }
warn()  { echo -e "\033[1;33m[WARN]\033[0m $*"; }
error() { echo -e "\033[1;31m[ERROR]\033[0m $*"; }

# ---------------------------
# Check required commands
# ---------------------------
for cmd in npm jq glib-compile-schemas zip gnome-extensions; do
    command -v "$cmd" >/dev/null 2>&1 || { error "$cmd is required but not installed."; exit 1; }
done

# ---------------------------
# Clean and lint
# ---------------------------
info "Formatting code..."
npm run format

info "Running lint..."
npm run lint

# ---------------------------
# Prepare variables
# ---------------------------
UUID=$(jq -r .uuid metadata.json)
ZIPNAME="$UUID.zip"
DIST_DIR="./dist"

# ---------------------------
# Compile schemas if present
# ---------------------------
if [ -d schemas ]; then
    info "Compiling schemas..."
    glib-compile-schemas schemas/
fi

# ---------------------------
# Prepare dist folder safely
# ---------------------------
info "Clearing dist folder..."
rm -rf "$DIST_DIR"
mkdir -p "$DIST_DIR"

# ---------------------------
# Copy files to dist
# ---------------------------
DIST_PATHS=("assets" "schemas" "src" "extension.js" "LICENSE" "metadata.json" "prefs.js" "README.md")

for path in "${DIST_PATHS[@]}"; do
    if [ -e "$path" ]; then
        cp -r "$path" "$DIST_DIR/$path"
        info "Copied $path to $DIST_DIR/$path"
    else
        warn "$path does not exist, skipping."
    fi
done

# ---------------------------
# Create zip package
# ---------------------------
info "Creating zip package..."
(
    cd "$DIST_DIR"
    zip -r "$ZIPNAME" . >/dev/null
)
info "Packaged as: $DIST_DIR/$ZIPNAME"

# ---------------------------
# Install and enable extension
# ---------------------------
info "Installing GNOME extension..."
gnome-extensions install "$DIST_DIR/$ZIPNAME" --force

info "Enabling GNOME extension..."
gnome-extensions enable "$UUID"

info "Build and install complete."
